% vim: ts=8 sts=8 sw=4 et tw=75
\chapter{AWK 总结}
\label{chap:awk_summary}

\marginpar{187}
这个附录包含了 awk 语言的一个总结. 在句法规则上, 如果某个成分被一对中括号
\verb'['...\verb']' 包围, 则表示它们是可选的.

\subsubsection{命令行}
\begin{quote}
    \texttt{awk [-F}\textit{s}\texttt{] '}%
    \textit{program}\texttt{'}\ \ \textit{optional list of filenames}

    \texttt{awk [-F}\textit{s}\texttt{] -f}
    \textit{progfile}\ \ \textit{optional list of filenames}
\end{quote}
参数 \texttt{-F}\textit{s} 把字段分隔符 \texttt{FS} 设置成 \textit{s},
如果没有提供文件名, awk 就从标准输入读取数据. 文件名的形式可以是 
\textit{var}\texttt{=}\textit{text}, 在这种情况下, 相当于把 \textit{text}
赋值给变量 \textit{var}, 当这个参数被当作一个文件而被访问时, 执行赋值
操作.

\subsubsection{AWK 程序}
一个 awk 程序由一系列的 \patact 语句和函数定义组成. 一个 \patact 语句具有
形式:
\begin{quote}
    \textit{pattern}\ \ \verb'{'\ \textit{action}\ \verb'}'
\end{quote}
如果某个动作省略了模式, 则默认匹配所有输入行; 如果某个模式省略了动作, 则
默认打印匹配行.

一个函数定义具有形式:
\begin{quote}
    \texttt{function}\ \
    \textit{name}\verb'('\textit{parameter-list}\verb') {'
        \textit{statement}\ \verb'}'
\end{quote}
\patact 语句和函数定义由换行符或分号分隔, 并且这两个字符可以混合使用.

\subsubsection{模式}
\begin{quote}
    \texttt{BEGIN}

    \texttt{END}

    \textit{expression}

    \verb'/'\textit{regular expression}\verb'/'

    \textit{pattern}\ \verb'&&'\ \textit{pattern}

    \textit{pattern}\ \verb'||'\ \textit{pattern}

    \verb'!'\textit{pattern}

    \verb'('\textit{pattern}\verb')'

    \textit{pattern}\verb','\ \textit{pattern}
\end{quote}

最后一个模式是范围模式, 它不能作为其他模式的组成部分. 类似地,
\texttt{BEGIN} 和 \texttt{END} 也不能和其他模式结合.
\marginpar{188}
\subsubsection{动作}
一个动作由一系列的语句组成, 这些语句包括:
\begin{quote}
    \texttt{break}

    \texttt{continue}

    \texttt{delete}\ \textit{array-element}

    \texttt{do}\ \textit{statement}\ \texttt{while}\
    \texttt{(}\textit{expression}\texttt{)}

    \texttt{exit[}\textit{expression}\texttt{]}

    \textit{expression}

    \texttt{if (}\textit{expression}\texttt{) }\textit{statement}
    \ \texttt{[else}\ \textit{statement}\texttt{]}

    \textit{input-output statement}

    \texttt{for (}\textit{expression}\texttt{; }\textit{expression}
    \texttt{; }\textit{expression}\texttt{) }\textit{statement}

    \texttt{for (}\textit{variable}\texttt{ in }\textit{array}\texttt{) }
    \textit{statement}

    \texttt{next}

    \texttt{return [}\textit{expression}\texttt{]}

    \texttt{while (}\textit{expression}\texttt{) statement}

    \verb'{' \textit{statement} \verb'}'
\end{quote}
一个单独的分号表示空语句. 在一个 \texttt{if-else} 语句中, 如果第一个 
\textit{statement} 和 \texttt{else} 出现在同一行, 那么它必须以分号结尾, 
或者用花括号包围起来. 类似地, 在 \texttt{do} 语句中, 如果
\textit{statement} 和 \texttt{while} 出现在同一行, 那么它必须以分号结尾,
或者用花括号包围起来.

\subsubsection{程序格式}
语句通过换行符或 (和) 分号隔开. 空行可以出现在任何语句, \patact 语句,
或函数定义的前面或后面. 空格与制表符可以插入到运算符或操作数的周围. 一条
长语句可以通过反斜杆延续到下一行. 另外, 如果一条语句在逗号, 左花括号,
\verb'&&', \verb'||', \texttt{do}, \texttt{else}, \texttt{if} 或 
\texttt{for} 的右括号后断行, 则不需要反斜杆. 由 \verb'#' 开始的注释可以
出现在任意一行的末尾.

\subsubsection{输入输出}
\begin{quote}
    \begin{tabbing}
        \texttt{close(}\textit{expr}\texttt{)}\hspace{8em} 
        \= 关闭由 \textit{expr}
        指示的文件或管道 \\
        \texttt{getline} \> 把 \verb'$0' 设置成下一条记录; 同时设置
        \texttt{NF}, \texttt{NR}, \texttt{FNR} \\

        \texttt{getline <}\textit{file} \> 把 \verb'$0' 设置成文件
        \textit{file} 的下一条记录; 同时设置 \texttt{NF} \\

        \texttt{getline}\ \textit{var} \> 把 \textit{var} 设置成下一条记录;
        同时设置 \texttt{NR}, \texttt{FNR} \\

        \texttt{getline}\ \textit{var}\ \texttt{<}\textit{file} \>  把
        \textit{var} 设置成文件  \textit{file} 的下一条记录. \\

        \texttt{print}  \> 打印当前记录 \\

        \texttt{print}\ \textit{expr-list} \> 打印 \textit{expr-list}
        所表示的表达式 \\

        \texttt{print}\ \textit{expr-list}\ \texttt{>}\textit{file} \>
        把表达式输出到文件 \textit{file} 中 \\

        \texttt{printf}\ \textit{fmt}\texttt{,} \textit{expr-list} \>
        格式化并输出 \\

        \texttt{printf}\ \textit{fmt}\texttt{,} \textit{expr-list}\ 
        \texttt{>} \textit{file}        \> 格式化并输出到文件 \textit{file}
        中 \\

        \texttt{system(}\textit{cmd-line}\texttt{)}     \> 执行命令
        \textit{cmd-line}, 返回命令的退出状态 \\
    \end{tabbing}
\end{quote}

\texttt{print} 后面的 \textit{expr-list}, 以及 \texttt{printf} 后面的
\textit{fmt}\texttt{,}\ \textit{expr-list} 可以用括号括起来. 在 
\texttt{print} 和 \texttt{printf} 中, \texttt{>>}\textit{file} 表示把
输出追加到文件 \textit{file} 的末尾, \texttt{|}\ \textit{command} 表示把
输出写到一个管道中. 类似的, \textit{command}\texttt{ | getline} 表示把
命令 \textit{command} 的输出以管道的方式输送给 \texttt{getline}. 函数
\texttt{getline} 在遇到文件末尾时返回 0, 出错时返回 -1.

\marginpar{189}

\subsubsection{\textbf{\texttt{printf}} 格式转换}
\texttt{printf} 与 \texttt{sprintf} 识别以下格式转换命令:
\begin{quote}
    \begin{tabbing}
        \verb'%c' \hspace{4em}      \= ASCII 字符 \\

        \verb'%d'       \> 十进制数 \\

        \verb'%e'       \> \texttt{[-]d.ddddddE[+-]dd}  \\

        \verb'%f'       \> \texttt{[-]ddd.dddddd} \\

        \verb'%g'       \> 效果等价于 \verb'%e' 或 \verb'%f', 选择转换
                后长度较短的那个, 无意义的零会被删除    \\

        \verb'%o'       \> 无符号八进制数 \\

        \verb'%s'       \> 字符串       \\

        \verb'%x'       \> 无符号十六进制数 \\

        \verb'%%'       \> 打印一个百分号 \verb'%', 不会有参数被转换 \\
    \end{tabbing}
\end{quote}

\verb'%' 与控制字符之间可以出现额外的参数:

\begin{quote}
    \begin{tabbing}
        \texttt{-} \hspace{4em}     \= 表达式在它所处的域中左对齐   \\

        \textit{width}  \> 当需要时, 把域的宽度填充到该值, 前导的
        \texttt{0} 表示用 \texttt{0} 填充 \\

        \texttt{.}\textit{prec} \> 字符串最大宽度, 或小数点后保留的位数 \\
    \end{tabbing}
\end{quote}

\subsubsection{内建变量}
下面列出的内建变量可以使用在任意一个表达式中:
\begin{quote}
    \begin{tabbing}
        \texttt{ARGC}\hspace{6em}   \= 命令行参数的个数 \\
        \texttt{ARGV}   \> 命令行参数组成的数组 (\texttt{ARGV[0..ARGC-1]})\\
        \texttt{FILENAME}\> 当前输入文件的文件名 \\
        \texttt{FNR}    \> 当前输入文件已读取的记录个数 \\
        \texttt{FS}     \> 输入数据的字段分隔符 (默认是空格) \\
        \texttt{NF}     \> 当前输入记录的字段个数 \\
        \texttt{NR}     \> 从程序开始到现在, 读取到的记录个数 \\
        \texttt{OFMT}   \> 数字的输出格式 (默认是 \verb'"%.6g"') \\
        \texttt{OFS}    \> 输出字段分隔符 (默认是空格)\\
        \texttt{ORS}    \> 输出记录分隔符 (默认是换行符) \\
        \texttt{RLENGTH}\> 被 \texttt{match} 中的正则表达式匹配的字符串
        的长度 \\
        \texttt{RS}     \> 输入数据的记录分隔符 (默认是换行符) \\
        \texttt{RSTART} \> 被 \texttt{match} 匹配的字符串在原字符串中的
        开始位置 \\
        \texttt{SUBSEP} \> 具有形式
        \texttt{[}\textit{i}\texttt{,}\textit{j}\texttt{,}...\texttt{]}
        的数组下标的分隔符 (默认是 \verb'"\034"') \\
    \end{tabbing}
\end{quote}
\texttt{ARGC} 和 \texttt{ARGV} 包含被执行的程序的名字 (通常是
\texttt{awk}), 但是不包括出现在命令行中的 awk 程序或选项.
\texttt{RLENGTH} 同时也是 \texttt{match} 的返回值.

\subsubsection{内建字符串函数}
在下面列出的字符串函数中, \textit{s} 和 \textit{t} 表示字符串, \textit{r}
表示正则表达式, \textit{i} 和 \textit{n} 表示整数.

\texttt{sub} 和 \texttt{gsub} 的替换字符串中的 \verb'&' 会被匹配的字符
串替换掉, 而 \verb'\&' 表示一个字面上的 \verb'&'.
\marginpar{190}
